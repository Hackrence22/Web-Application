import{_ as S,N as F,a as v,r as P,c as n,b as M,d as t,w as I,v as N,F as w,e as f,t as m,f as u,g as H,h as C,i as B,o as l,n as _}from"./app-D2VWRCt5.js";const U="/build/assets/User-5NOEtKkp.png",D="/build/assets/room2-Bg2gi4u4.png",A={name:"UserReviews",components:{Navbar:F},data(){return{isLoggedIn:!1,userName:"",boardingHouseId:null,boardingHouse:null,reviews:{},roomReviews:{},loading:!1,error:null,userImage:U,defaultRoomImage:D,boardingHouses:[],selectedBoardingHouseId:"",rooms:[],showModal:!1,selectedImage:null,showEditModal:!1,editingReview:null,currentUserId:localStorage.getItem("userId")}},computed:{sortedReviews(){return[...this.reviews].sort((e,s)=>new Date(s.date)-new Date(e.date))}},mounted(){const e=localStorage.getItem("userName"),s=localStorage.getItem("token");if(e&&s&&(this.isLoggedIn=!0,this.userName=e),this.boardingHouseId=this.$route.params.id,!this.boardingHouseId){console.error("No boarding house ID provided");return}console.log("Mounted with boarding house ID:",this.boardingHouseId),this.fetchBoardingHouseDetails(),this.fetchRooms().then(()=>{this.fetchReviews()}),this.fetchBoardingHouses()},methods:{formatDate(e){return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})},async fetchBoardingHouseDetails(){try{console.log("Fetching details for boarding house:",this.boardingHouseId);const e=await v.get(`/user/boarding-houses/${this.boardingHouseId}/details`);if(e.data.status==="success"&&e.data.data)this.boardingHouse=e.data.data,console.log("Boarding house details:",this.boardingHouse);else throw new Error(e.data.message||"Failed to fetch boarding house")}catch(e){console.error("Error fetching boarding house details:",e),this.error=e.message||"Failed to fetch boarding house details",this.boardingHouse=null}},async fetchReviews(){this.loading=!0,this.error=null;try{if(!this.rooms||!this.rooms.length){console.log("No rooms available to fetch reviews for");return}this.reviews={};for(const e of this.rooms)try{console.log(`Fetching reviews for room ${e.room_id}`);const s=await v.get(`/user/rooms/${e.room_id}/reviews`);console.log("Raw response:",s),s.data.status==="success"?Array.isArray(s.data.data)?(console.log(`Reviews found for room ${e.room_id}:`,s.data.data),this.reviews[e.room_id]=s.data.data):(console.warn(`Invalid reviews data format for room ${e.room_id}`),this.reviews[e.room_id]=[]):(console.warn(`No reviews found for room ${e.room_id}`),this.reviews[e.room_id]=[])}catch(s){console.error(`Error fetching reviews for room ${e.room_id}:`,s),s.response&&console.error("Error response:",s.response.data),this.reviews[e.room_id]=[]}console.log("Final reviews object:",this.reviews)}catch(e){console.error("Error fetching reviews:",e),this.error="Failed to fetch reviews. Please try again later."}finally{this.loading=!1}},async submitReview(){if(!this.isLoggedIn){alert("Please log in to submit a review");return}if(!this.newReview.rating||!this.newReview.comment){alert("Please provide both rating and comment");return}if(!this.isSubmitting){this.isSubmitting=!0;try{const e=new FormData;e.append("boarding_house_id",this.boardingHouseId),e.append("rating",this.newReview.rating),e.append("comment",this.newReview.comment),this.newReview.image&&e.append("image",this.newReview.image);const s=await v.post("/boarding-houses/reviews",e,{headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${localStorage.getItem("token")}`}});if(s.data.status==="success"){const d={id:s.data.data.id,userName:this.userName,date:new Date().toISOString(),rating:this.newReview.rating,comment:this.newReview.comment,image:s.data.data.image_url};this.reviews.unshift(d),this.newReview={rating:0,comment:"",image:null};const c=document.getElementById("fileInput");c&&(c.value=""),alert("Review submitted successfully!")}else throw new Error(s.data.message||"Failed to submit review")}catch(e){console.error("Error submitting review:",e),alert("Failed to submit review. Please try again.")}finally{this.isSubmitting=!1}}},handleFileUpload(e,s){const d=e.target.files;d&&(this.roomReviews[s]||(this.roomReviews[s]={rating:0,comment:"",images:[],imagePreviews:[]}),Array.from(d).forEach(c=>{if(c.size>5e6){alert("File size should not exceed 5MB");return}if(!c.type.startsWith("image/")){alert("Please upload image files only");return}const o=URL.createObjectURL(c);this.roomReviews[s].images.push(c),this.roomReviews[s].imagePreviews.push(o)}))},navigate(e){const s=e.target.value;s==="/login"?this.handleLogout():this.$router.push(s)},handleLogout(){localStorage.removeItem("userName"),localStorage.removeItem("userId"),localStorage.removeItem("token"),this.$router.push("/login")},setRating(e){this.newReview.rating=e},getBoardingHouseImage(e){return e?e.startsWith("http")?e:`/storage/${e}`:this.defaultRoomImage},async fetchBoardingHouses(){try{const e=await v.get("/boarding-houses/available");if(e.data.status==="success")this.boardingHouses=e.data.data,this.boardingHouseId&&(this.selectedBoardingHouseId=this.boardingHouseId);else throw new Error(e.data.message||"Failed to fetch boarding houses")}catch(e){console.error("Error fetching boarding houses:",e)}},async onBoardingHouseChange(){this.selectedBoardingHouseId&&(this.$router.push({name:"user.reviews",params:{id:this.selectedBoardingHouseId}},()=>{},{replace:!0}),this.boardingHouseId=this.selectedBoardingHouseId,await Promise.all([this.fetchBoardingHouseDetails(),this.fetchRooms().then(()=>this.fetchReviews())]))},async fetchRooms(){try{if(!this.boardingHouseId){console.warn("No boarding house ID provided");return}const e=await v.get(`/user/rooms/${this.boardingHouseId}/list`);if(e.data.status==="success")this.rooms=e.data.data,this.rooms.forEach(s=>{this.roomReviews[s.room_id]||(this.roomReviews[s.room_id]={rating:0,comment:"",images:[],imagePreviews:[]})});else throw new Error(e.data.message||"Failed to fetch rooms")}catch(e){console.error("Error fetching rooms:",e),this.rooms=[]}},getRoomImage(e){return e?e.startsWith("http")?e:`/storage/${e}`:this.defaultRoomImage},getRoomReviews(e){const s=this.reviews[e]||[];return console.log(`Getting reviews for room ${e}:`,s),s},setRoomRating(e,s){this.roomReviews[e]||(this.roomReviews[e]={rating:0,comment:"",images:[],imagePreviews:[]}),this.roomReviews[e].rating=s},canSubmitReview(e){const s=this.roomReviews[e];return s&&s.rating>0&&s.comment.trim()!==""},async submitRoomReview(e){var s,d,c;try{if(!this.boardingHouseId)throw new Error("Boarding house ID is missing");const o=new FormData;o.append("room_id",e),o.append("boarding_house_id",this.boardingHouseId),o.append("rating",this.roomReviews[e].rating),o.append("comment",this.roomReviews[e].comment),console.log("Submitting review for:",{roomId:e,boardingHouseId:this.boardingHouseId,rating:this.roomReviews[e].rating,comment:this.roomReviews[e].comment}),((s=this.roomReviews[e].images)==null?void 0:s.length)>0&&this.roomReviews[e].images.forEach((b,p)=>{o.append(`images[${p}]`,b)}),(await v.post("/user/reviews",o,{headers:{"Content-Type":"multipart/form-data","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}})).data.status==="success"&&(this.resetReviewForm(e),await this.fetchRoomReviews(e),alert("Review submitted successfully!"))}catch(o){console.error("Error submitting review:",o),(c=(d=o.response)==null?void 0:d.data)!=null&&c.message?alert(o.response.data.message):alert(o.message||"Failed to submit review. Please try again.")}},openModal(e){this.selectedImage=e,this.showModal=!0,document.body.style.overflow="hidden"},closeModal(){this.showModal=!1,this.selectedImage=null,document.body.style.overflow="auto"},getImagePreview(e){return e?e.startsWith("http")?e:`/storage/${e}`:this.defaultRoomImage},removeImage(e,s){this.roomReviews[e]&&(this.roomReviews[e].images.splice(s,1),this.roomReviews[e].imagePreviews.splice(s,1))},handleImageError(e){console.error("Image failed to load:",e.target.src),e.target.src=this.defaultRoomImage},isReviewOwner(e){return parseInt(e.user_id)===parseInt(this.currentUserId)},editReview(e){console.log("Editing review with images:",e.images),this.editingReview={id:e.id,rating:e.rating,comment:e.comment,images:[],existingImages:Array.isArray(e.images)?e.images:JSON.parse(e.images||"[]"),imagePreviews:[]},this.editingReview.imagePreviews=this.editingReview.existingImages.map(s=>`/storage/${s}`),this.showEditModal=!0},handleEditFileUpload(e){const s=e.target.files;s&&Array.from(s).forEach(d=>{if(d.size>5e6){alert("File size should not exceed 5MB");return}if(!d.type.startsWith("image/")){alert("Please upload image files only");return}this.editingReview.images.push(d),this.editingReview.imagePreviews.push(URL.createObjectURL(d))})},removeEditImage(e){if(e<this.editingReview.existingImages.length)this.editingReview.existingImages.splice(e,1);else{const s=e-this.editingReview.existingImages.length;this.editingReview.images.splice(s,1)}this.editingReview.imagePreviews.splice(e,1)},async saveEditedReview(){var e,s;try{const d=new FormData;d.append("rating",this.editingReview.rating),d.append("comment",this.editingReview.comment),d.append("_method","PUT"),d.append("existing_images",JSON.stringify(this.editingReview.existingImages)),this.editingReview.images.forEach((o,r)=>{d.append(`images[${r}]`,o)}),(await v.post(`/user/reviews/${this.editingReview.id}`,d,{headers:{"Content-Type":"multipart/form-data","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}})).data.status==="success"&&(await this.fetchReviews(),this.closeEditModal(),alert("Review updated successfully!"))}catch(d){console.error("Error updating review:",d),alert(((s=(e=d.response)==null?void 0:e.data)==null?void 0:s.message)||"Failed to update review")}},async deleteReview(e){var s,d;if(confirm("Are you sure you want to delete this review?"))try{(await v.delete(`/user/reviews/${e}`)).data.status==="success"&&(await this.refreshReviews(),alert("Review deleted successfully!"))}catch(c){console.error("Error deleting review:",c),alert(((d=(s=c.response)==null?void 0:s.data)==null?void 0:d.message)||"Failed to delete review")}},async fetchRoomReviews(e){try{console.log(`Fetching reviews for room ${e}`);const s=await v.get(`/user/rooms/${e}/reviews`);if(console.log("Review response:",s.data),s.data.status==="success"){const d=s.data.data.map(c=>({...c,images:Array.isArray(c.images)?c.images:typeof c.images=="string"?JSON.parse(c.images):[]}));this.reviews={...this.reviews,[e]:d},console.log(`Updated reviews for room ${e}:`,this.reviews[e])}}catch(s){console.error(`Error fetching reviews for room ${e}:`,s),this.reviews[e]=[]}},async refreshReviews(){try{if(!this.rooms||!this.rooms.length)return;const e=this.rooms.map(s=>this.fetchRoomReviews(s.room_id));await Promise.all(e)}catch(e){console.error("Error refreshing reviews:",e),this.error="Failed to refresh reviews"}},resetReviewForm(e){this.roomReviews[e]={rating:0,comment:"",images:[],imagePreviews:[]}},closeEditModal(){this.showEditModal=!1,this.editingReview=null},getUserProfileImage(e){return e?e.startsWith("http")?e:`/storage/${e}`:this.userImage},handleProfileImageError(e){console.error("Profile image failed to load:",e.target.src),e.target.src=this.userImage}},watch:{"$route.params.id":{handler(e){e&&e!==this.boardingHouseId&&!this.selectedBoardingHouseId&&(this.boardingHouseId=e,this.selectedBoardingHouseId=e,this.fetchBoardingHouseDetails(),this.fetchRooms(),this.fetchReviews())},immediate:!0}},created(){if(!localStorage.getItem("token")){console.error("No authentication token found");return}this.boardingHouseId&&(this.fetchBoardingHouseDetails(),this.fetchRooms(),this.fetchReviews()),this.fetchBoardingHouses()}},L={id:"app"},O={class:"overall"},x={class:"content-wrapper"},W={class:"home"},T=["value"],V={key:0,class:"containss"},z={class:"head"},J=["src","alt"],j={class:"rooms-section"},K={class:"rooms-grid"},q=["src","alt","onClick"],X={class:"room-details"},G={class:"room-name"},Y={class:"room-price"},Q={class:"room-reviews"},Z={key:0,class:"loading-state"},$={key:1,class:"error-state"},ee={key:2,class:"no-reviews"},se={key:3,class:"review-list"},te={class:"review-header"},ie={class:"user-profile"},oe=["src","alt"],re={class:"review-info"},ae={class:"users"},ne={class:"date"},le={key:0,class:"review-actions"},de=["onClick"],ce=["onClick"],ge={class:"stars"},me={class:"rates"},ue={key:0,class:"comment"},he={key:1,class:"review-images-grid"},ve=["onClick"],we=["src","alt"],fe={key:4,class:"add-review-form"},pe={class:"rating-input"},Re=["onClick"],_e={class:"review-input-container"},be={class:"message-box"},ye=["onUpdate:modelValue"],Ie={key:0,class:"image-previews-container"},ke=["src"],Ee=["onClick"],He={class:"message-actions"},Ce={class:"left-actions"},Be=["for"],Se=["id","onChange"],Fe=["onClick","disabled"],Pe={class:"modal-content"},Me=["src"],Ne={key:1,class:"edit-modal"},Ue={class:"rating-input"},De=["onClick"],Ae={key:0,class:"edit-image-previews"},Le=["src"],Oe=["onClick"],xe={class:"edit-image-upload"},We={class:"edit-modal-actions"};function Te(e,s,d,c,o,r){var p,k;const b=P("Navbar");return l(),n("div",L,[M(b),t("div",O,[t("div",x,[t("div",W,[s[15]||(s[15]=t("h4",{class:"helper"},"Room Reviews",-1)),I(t("select",{"onUpdate:modelValue":s[0]||(s[0]=i=>o.selectedBoardingHouseId=i),onChange:s[1]||(s[1]=(...i)=>r.onBoardingHouseChange&&r.onBoardingHouseChange(...i)),class:"boarding-house-select"},[s[14]||(s[14]=t("option",{value:"",disabled:""},"Select a Boarding House",-1)),(l(!0),n(w,null,f(o.boardingHouses,i=>(l(),n("option",{key:i.boarding_house_id,value:i.boarding_house_id},m(i.name),9,T))),128))],544),[[N,o.selectedBoardingHouseId]])]),o.boardingHouse?(l(),n("div",V,[t("h4",z,m(o.boardingHouse.name),1),t("img",{src:r.getBoardingHouseImage((p=o.boardingHouse)==null?void 0:p.bh_images),alt:o.boardingHouse.name,class:"img",onClick:s[2]||(s[2]=i=>{var h;return r.openModal(r.getBoardingHouseImage((h=o.boardingHouse)==null?void 0:h.bh_images))}),style:{cursor:"pointer"}},null,8,J),t("div",j,[s[21]||(s[21]=t("h5",{class:"section-title"},"Rooms",-1)),t("div",K,[(l(!0),n(w,null,f(o.rooms,i=>{var h,y;return l(),n("div",{key:i.room_id,class:"room-card"},[t("img",{src:r.getRoomImage(i.room_images),alt:i.room_name,class:"room-image",onClick:a=>r.openModal(r.getRoomImage(i.room_images)),style:{cursor:"pointer"}},null,8,q),t("div",X,[t("h6",G,m(i.room_name),1),t("p",Y,"₱"+m(i.price)+"/month",1),t("p",{class:_(["room-status",i.status.toLowerCase()])}," Status: "+m(i.status),3),t("div",Q,[s[20]||(s[20]=t("h6",{class:"reviews-title"},"Reviews for this room",-1)),o.loading?(l(),n("div",Z," Loading reviews... ")):u("",!0),o.error?(l(),n("div",$,m(o.error),1)):r.getRoomReviews(i.room_id).length===0?(l(),n("div",ee,m(console.log("Reviews length for room",i.room_id,":",r.getRoomReviews(i.room_id).length))+" No reviews yet for this room ",1)):(l(),n("div",se,[(l(!0),n(w,null,f(r.getRoomReviews(i.room_id),a=>(l(),n("div",{key:a.id,class:"review-item"},[t("div",te,[t("div",ie,[t("img",{src:r.getUserProfileImage(a.user_profile),alt:a.userName,class:"user",onError:s[3]||(s[3]=(...g)=>r.handleProfileImageError&&r.handleProfileImageError(...g))},null,40,oe),t("div",re,[t("p",ae,m(a.userName),1),t("p",ne,m(r.formatDate(a.date)),1)])]),r.isReviewOwner(a)?(l(),n("div",le,[t("button",{class:"action-btn edit",onClick:g=>r.editReview(a)},s[16]||(s[16]=[t("i",{class:"fas fa-edit"},null,-1)]),8,de),t("button",{class:"action-btn delete",onClick:g=>r.deleteReview(a.id)},s[17]||(s[17]=[t("i",{class:"fas fa-trash"},null,-1)]),8,ce)])):u("",!0)]),t("div",ge,[(l(),n(w,null,f(5,g=>t("span",{key:g,class:_(["star",{active:g<=a.rating}])},"★",2)),64))]),t("p",me,"Rating: "+m(a.rating)+"/5",1),a.comment?(l(),n("p",ue,m(a.comment),1)):u("",!0),a.images&&a.images.length>0?(l(),n("div",he,[(l(!0),n(w,null,f(Array.isArray(a.images)?a.images:JSON.parse(a.images),(g,R)=>(l(),n("div",{key:R,class:"review-image-container",onClick:E=>r.openModal(`/storage/${g}`)},[t("img",{src:`/storage/${g}`,alt:`Review image ${R+1}`,class:"review-image",onError:s[4]||(s[4]=(...E)=>r.handleImageError&&r.handleImageError(...E))},null,40,we)],8,ve))),128))])):u("",!0)]))),128))])),o.isLoggedIn?(l(),n("div",fe,[s[19]||(s[19]=t("h6",{class:"form-title"},"Add Your Review",-1)),t("div",pe,[(l(),n(w,null,f(5,a=>{var g;return t("span",{key:a,class:_(["star",{active:a<=((g=o.roomReviews[i.room_id])==null?void 0:g.rating)}]),onClick:R=>r.setRoomRating(i.room_id,a)},"★",10,Re)}),64))]),t("div",_e,[t("div",be,[I(t("textarea",{"onUpdate:modelValue":a=>o.roomReviews[i.room_id].comment=a,placeholder:"Write your review here...",class:"comment-input"},null,8,ye),[[C,o.roomReviews[i.room_id].comment]]),(y=(h=o.roomReviews[i.room_id])==null?void 0:h.imagePreviews)!=null&&y.length?(l(),n("div",Ie,[(l(!0),n(w,null,f(o.roomReviews[i.room_id].imagePreviews,(a,g)=>(l(),n("div",{key:g,class:"preview-item"},[t("img",{src:a,alt:"Preview",class:"preview-img"},null,8,ke),t("button",{onClick:R=>r.removeImage(i.room_id,g),class:"remove-preview-btn"},"×",8,Ee)]))),128))])):u("",!0)]),t("div",He,[t("div",Ce,[t("label",{for:"file-input-"+i.room_id,class:"upload-btn"},s[18]||(s[18]=[t("img",{src:B,alt:"Upload",class:"upload-icon"},null,-1)]),8,Be),t("input",{id:"file-input-"+i.room_id,type:"file",accept:"image/*",class:"file",onChange:a=>r.handleFileUpload(a,i.room_id),multiple:""},null,40,Se)]),t("button",{class:"send-btn",onClick:a=>r.submitRoomReview(i.room_id),disabled:!r.canSubmitReview(i.room_id)}," Submit Review ",8,Fe)])])])):u("",!0)])])])}),128))])])])):u("",!0)])]),o.showModal?(l(),n("div",{key:0,class:"modal",onClick:s[7]||(s[7]=(...i)=>r.closeModal&&r.closeModal(...i))},[t("div",Pe,[t("button",{class:"modal-close",onClick:s[5]||(s[5]=(...i)=>r.closeModal&&r.closeModal(...i))},"×"),t("img",{src:o.selectedImage,alt:"Enlarged view",onClick:s[6]||(s[6]=H(()=>{},["stop"]))},null,8,Me)])])):u("",!0),o.showEditModal?(l(),n("div",Ne,[t("div",{class:"edit-modal-content",onClick:s[13]||(s[13]=H(()=>{},["stop"]))},[t("button",{class:"modal-close",onClick:s[8]||(s[8]=(...i)=>r.closeEditModal&&r.closeEditModal(...i))},"×"),s[23]||(s[23]=t("h3",null,"Edit Review",-1)),t("div",Ue,[(l(),n(w,null,f(5,i=>t("span",{key:i,class:_(["star",{active:i<=o.editingReview.rating}]),onClick:h=>o.editingReview.rating=i},"★",10,De)),64))]),I(t("textarea",{"onUpdate:modelValue":s[9]||(s[9]=i=>o.editingReview.comment=i),class:"edit-comment-input",placeholder:"Write your review here..."},null,512),[[C,o.editingReview.comment]]),(k=o.editingReview.imagePreviews)!=null&&k.length?(l(),n("div",Ae,[(l(!0),n(w,null,f(o.editingReview.imagePreviews,(i,h)=>(l(),n("div",{key:h,class:"preview-item"},[t("img",{src:i,alt:"Preview",class:"preview-img"},null,8,Le),t("button",{onClick:y=>r.removeEditImage(h),class:"remove-preview-btn"},"×",8,Oe)]))),128))])):u("",!0),t("div",xe,[s[22]||(s[22]=t("label",{for:"edit-file-input",class:"upload-btn"},[t("img",{src:B,alt:"Upload",class:"upload-icon"}),t("span",null,"Add Images")],-1)),t("input",{id:"edit-file-input",type:"file",accept:"image/*",class:"file",onChange:s[10]||(s[10]=(...i)=>r.handleEditFileUpload&&r.handleEditFileUpload(...i)),multiple:""},null,32)]),t("div",We,[t("button",{class:"cancel-btn",onClick:s[11]||(s[11]=(...i)=>r.closeEditModal&&r.closeEditModal(...i))},"Cancel"),t("button",{class:"save-btn",onClick:s[12]||(s[12]=(...i)=>r.saveEditedReview&&r.saveEditedReview(...i))},"Save Changes")])])])):u("",!0)])}const ze=S(A,[["render",Te],["__scopeId","data-v-27a1cc22"]]);export{ze as default};
